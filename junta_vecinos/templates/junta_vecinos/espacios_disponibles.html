{% extends 'junta_vecinos/base.html' %}

{% block title %}Reserva de Espacios{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Reserva de Espacios</h2>
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Selecciona un espacio</h5>
                    <select id="space-select" class="form-select">
                        <option value="">Seleccione un espacio</option>
                        {% for espacio in espacios %}
                            <option value="{{ espacio.id }}">{{ espacio.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div id="espacio-info" class="card mt-3" style="width: 18rem; display: none;">
                <img id="espacio-foto" src="" class="card-img-top" alt="Foto del espacio">
                <div class="card-body">
                    <h5 id="espacio-nombre" class="card-title"></h5>
                    <p id="espacio-ubicacion" class="card-text"></p>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<!-- Modal para mostrar los horarios disponibles -->
<div class="modal fade" id="timeSlotModal" tabindex="-1" aria-labelledby="timeSlotModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="timeSlotModalLabel">Horarios Disponibles</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="time-slots" class="d-flex flex-wrap justify-content-start"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    var selectedDate = '';
    var selectedEspacioId = '';
    var timeSlotModal = new bootstrap.Modal(document.getElementById('timeSlotModal'));
    var selectedSlots = [];

    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'es',
        initialView: 'dayGridMonth',
        dateClick: function(info) {
            selectedDate = info.dateStr;
            if (selectedEspacioId) {
                loadTimeSlots(selectedDate);
            } else {
                alert('Por favor, selecciona un espacio primero.');
            }
        }
    });
    calendar.render();

    document.getElementById('space-select').addEventListener('change', function() {
        selectedEspacioId = this.value;
        if (selectedEspacioId) {
            fetch(`/api/get-espacio-info/?espacio_id=${selectedEspacioId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('espacio-foto').src = data.foto;
                    document.getElementById('espacio-nombre').textContent = data.nombre;
                    document.getElementById('espacio-ubicacion').textContent = data.ubicacion;
                    document.getElementById('espacio-info').style.display = 'block';
                });
        } else {
            document.getElementById('espacio-info').style.display = 'none';
        }
    });

    function loadTimeSlots(date) {
        fetch(`/api/get-available-slots/?date=${date}&espacio_id=${selectedEspacioId}`)
            .then(response => response.json())
            .then(data => {
                var timeSlotsContainer = document.getElementById('time-slots');
                timeSlotsContainer.innerHTML = '';
                selectedSlots = [];
                data.slots.forEach((slot, index) => {
                    var button = document.createElement('button');
                    button.className = slot.available ? 'btn btn-outline-primary m-1' : 'btn btn-danger m-1';
                    button.textContent = `${slot.start} - ${slot.end}`;
                    button.dataset.index = index;
                    if (slot.available) {
                        button.onclick = function() {
                            toggleSlotSelection(this, index, data.slots);
                        };
                    } else {
                        button.disabled = true;
                    }
                    timeSlotsContainer.appendChild(button);
                });
                var reserveButton = document.createElement('button');
                reserveButton.className = 'btn btn-success mt-3';
                reserveButton.textContent = 'Reservar';
                reserveButton.onclick = function() {
                    if (selectedSlots.length === 2) {
                        reserveSlots(data.slots);
                    } else {
                        alert('Por favor, selecciona dos slots para hacer una reserva.');
                    }
                };
                timeSlotsContainer.appendChild(reserveButton);
                document.getElementById('timeSlotModalLabel').textContent = `Horarios Disponibles para ${date}`;
                timeSlotModal.show();
            });
    }

    function toggleSlotSelection(button, index, slots) {
        var slotIndex = selectedSlots.indexOf(index);
        if (slotIndex > -1) {
            // Deseleccionar slot
            selectedSlots.splice(slotIndex, 1);
            button.classList.remove('btn-primary');
            button.classList.add('btn-outline-primary');
        } else {
            // Seleccionar slot
            if (selectedSlots.length < 2) {
                selectedSlots.push(index);
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-primary');
            } else {
                // Ya hay dos slots seleccionados, deseleccionar el primero y seleccionar el nuevo
                var firstSelectedButton = document.querySelector(`button[data-index="${selectedSlots[0]}"]`);
                if (firstSelectedButton) {
                    firstSelectedButton.classList.remove('btn-primary');
                    firstSelectedButton.classList.add('btn-outline-primary');
                }
                selectedSlots.shift();
                selectedSlots.push(index);
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-primary');
            }
        }
        selectedSlots.sort((a, b) => a - b);
    }

    function reserveSlots(slots) {
        var startTime = slots[selectedSlots[0]].start;
        var endTime = slots[selectedSlots[1]].end;
        
        fetch(`/espacio/${selectedEspacioId}/reservar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                fecha: selectedDate,
                hora_inicio: startTime,
                hora_fin: endTime
            })
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert('Reserva realizada con Ã©xito');
                  timeSlotModal.hide();
                  calendar.refetchEvents();
                  selectedSlots = [];
              } else {
                  alert('Error al realizar la reserva: ' + data.error);
              }
          })
          .catch(error => {
              console.error('Error:', error);
              alert('Error al realizar la reserva');
          });
    }
});
</script>
{% endblock %}