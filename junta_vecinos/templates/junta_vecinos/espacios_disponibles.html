{% extends 'junta_vecinos/base.html' %}

{% block title %}Reserva de Espacios{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Reserva de Espacios</h2>
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Selecciona un espacio</h5>
                    <select id="space-select" class="form-select">
                        <option value="">Seleccione un espacio</option>
                        {% for espacio in espacios %}
                            <option value="{{ espacio.id }}">{{ espacio.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div id="espacio-info" class="card mt-3" style="width: 18rem; display: none;">
                <img id="espacio-foto" src="" class="card-img-top" alt="Foto del espacio">
                <div class="card-body">
                    <h5 id="espacio-nombre" class="card-title"></h5>
                    <p id="espacio-ubicacion" class="card-text"></p>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div id="calendar"></div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-12">
            <div id="time-slots" class="d-flex flex-wrap justify-content-start"></div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var selectedDate = '';
        var selectedEspacioId = '';
    
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'es',
            initialView: 'dayGridMonth',
            dateClick: function(info) {
                selectedDate = info.dateStr;
                loadTimeSlots(selectedDate);
            }
        });
        calendar.render();
    
        document.getElementById('space-select').addEventListener('change', function() {
            selectedEspacioId = this.value;
            if (selectedEspacioId) {
                fetch(`/api/get-espacio-info/?espacio_id=${selectedEspacioId}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('espacio-foto').src = data.foto;
                        document.getElementById('espacio-nombre').textContent = data.nombre;
                        document.getElementById('espacio-ubicacion').textContent = data.ubicacion;
                        document.getElementById('espacio-info').style.display = 'block';
                    });
                if (selectedDate) {
                    loadTimeSlots(selectedDate);
                }
            } else {
                document.getElementById('espacio-info').style.display = 'none';
            }
        });
    
        function loadTimeSlots(date) {
            if (!selectedEspacioId) {
                alert('Por favor, selecciona un espacio primero.');
                return;
            }
    
            fetch(`/api/get-available-slots/?date=${date}&espacio_id=${selectedEspacioId}`)
                .then(response => response.json())
                .then(data => {
                    var timeSlotsContainer = document.getElementById('time-slots');
                    timeSlotsContainer.innerHTML = '';
                    data.slots.forEach(slot => {
                        var button = document.createElement('button');
                        button.className = slot.available ? 'btn btn-outline-primary m-1' : 'btn btn-danger m-1';
                        button.textContent = `${slot.start} - ${slot.end}`;
                        if (slot.available) {
                            button.onclick = function() {
                                reserveSlot(date, slot.start, slot.end);
                            };
                        } else {
                            button.disabled = true;
                        }
                        timeSlotsContainer.appendChild(button);
                    });
                });
        }
    
        function reserveSlot(date, startTime, endTime) {
            fetch(`/espacio/${selectedEspacioId}/reservar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    fecha: date,
                    hora_inicio: startTime,
                    hora_fin: endTime
                })
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      alert('Reserva realizada con éxito');
                      loadTimeSlots(selectedDate);  // Recargar los slots después de una reserva exitosa
                  } else {
                      alert('Error al realizar la reserva: ' + data.error);
                  }
              })
              .catch(error => {
                  console.error('Error:', error);
                  alert('Error al realizar la reserva');
              });
        }
    });
</script>
{% endblock %}