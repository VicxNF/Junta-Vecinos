<!-- templates/junta_vecinos/espacios_disponibles.html -->
{% extends 'junta_vecinos/base.html' %}

{% block title %}Espacios Disponibles{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Espacios Disponibles</h2>
    <ul class="list-group">
        {% for espacio in espacios %}
            <li class="list-group-item">
                <h5>{{ espacio.nombre }}</h5>
                <p>{{ espacio.descripcion }}</p>
                <p>Capacidad: {{ espacio.capacidad }}</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#calendarModal" data-espacio-id="{{ espacio.id }}">
                    Reservar
                </button>
            </li>
        {% empty %}
            <li class="list-group-item">No hay espacios disponibles</li>
        {% endfor %}
    </ul>
</div>

<!-- Modal para seleccionar la fecha -->
<div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calendarModalLabel">Seleccionar Fecha</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para seleccionar la hora -->
<div class="modal fade" id="hoursModal" tabindex="-1" aria-labelledby="hoursModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="hoursModalLabel">Seleccionar horas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Selecciona la hora de inicio y fin para la reserva:</p>
                <label for="hora_inicio">Hora de inicio:</label>
                <input type="time" id="hora_inicio" class="form-control">
                <label for="hora_fin" class="mt-2">Hora de fin:</label>
                <input type="time" id="hora_fin" class="form-control">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="reserveButton" class="btn btn-primary">Reservar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var selectedDate = ''; // Variable global para la fecha seleccionada
    var espacioId = ''; // Variable global para el ID del espacio seleccionado

    // Inicializar el calendario
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'es',
        initialView: 'dayGridMonth',
        dateClick: function(info) {
            // Guardar la fecha seleccionada
            selectedDate = info.dateStr;
            console.log("Fecha seleccionada: " + selectedDate); // Debugging
            $('#calendarModal').modal('hide'); // Cerrar el modal de calendario
            $('#hoursModal').modal('show'); // Mostrar el modal de horas
        }
    });

    calendar.render();

    // Manejar el clic en el botón de reserva
    document.querySelectorAll('button[data-bs-target="#calendarModal"]').forEach(function(button) {
        button.addEventListener('click', function() {
            espacioId = this.getAttribute('data-espacio-id'); // Obtener el ID del espacio
            console.log("ID del espacio: " + espacioId); // Debugging
            $('#calendar').fullCalendar('destroy'); // Destruir el calendario anterior si es necesario
            calendar.render(); // Volver a renderizar el calendario
        });
    });

    // Agregar evento al botón de reservar en el modal de horas
    document.getElementById('reserveButton').onclick = function() {
    var horaInicio = document.getElementById('hora_inicio').value;
    var horaFin = document.getElementById('hora_fin').value;

    // Validar que las horas de inicio y fin sean correctas
    if (horaInicio && horaFin) {
        console.log("Reserva:", { fecha: selectedDate, hora_inicio: horaInicio, hora_fin: horaFin }); // Debugging
        fetch(`/espacio/${espacioId}/reservar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                fecha: selectedDate,
                hora_inicio: horaInicio,
                hora_fin: horaFin
            })
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert('Reserva realizada con éxito');
                  $('#hoursModal').modal('hide');
                  calendar.refetchEvents(); // Actualizar calendario
                  
                  // Redirigir al index
                  window.location.href = '{% url "index" %}';
              } else {
                  alert('Error al realizar la reserva: ' + data.error);
              }
          })
          .catch(error => {
              console.error('Error:', error);
              alert('Error al realizar la reserva');
          });
    } else {
        alert('Por favor, selecciona las horas de inicio y fin.');
    }
};
});
</script>
{% endblock %}