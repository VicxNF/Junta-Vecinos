{% extends 'junta_vecinos/base.html' %}

{% block content %}
<div class="container mt-4">
    
    

    <div class="container mt-4">
        {% if user.is_superuser %}
        <h2>Actividades Vecinales - {{ comuna }}</h2>
        
        <!-- Sección de Estadísticas Rápidas -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title mb-4">Estadísticas Generales</h3>
                        <div class="row">
                            <div class="col-md-4 text-center">
                                <h5>Total Actividades</h5>
                                <h2 class="text-primary">{{ total_actividades }}</h2>
                            </div>
                            <div class="col-md-4 text-center">
                                <h5>Total Inscritos</h5>
                                <h2 class="text-success">{{ total_inscritos }}</h2>
                            </div>
                            <div class="col-md-4 text-center">
                                <h5>Ingresos Totales</h5>
                                <h2 class="text-info">${{ total_ingresos|floatformat:2 }}</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Gráficos -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Tendencia Mensual</h4>
                        <canvas id="tendenciaChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Generar Reporte</h4>
                        <form method="get" action="{% url 'generar_reporte_actividades_pdf' %}" class="row g-3">
                            <div class="col-md-6">
                                <label for="year" class="form-label">Año</label>
                                <select name="year" id="year" class="form-select">
                                    {% for year in years %}
                                        <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>
                                            {{ year }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="month" class="form-label">Mes</label>
                                <select name="month" id="month" class="form-select">
                                    {% for month_num, month_name in months %}
                                        <option value="{{ month_num }}" {% if month_num == current_month %}selected{% endif %}>
                                            {{ month_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-file-pdf me-2"></i>Generar Reporte PDF
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <h2>Actividades Vecinales</h2>
        {% endif %}
    
    <div class="row">
        {% for actividad in actividades %}
        <div class="col-md-4 mb-4">
            <div class="card">
                {% if actividad.imagen %}
                <img src="{{ actividad.imagen.url }}" class="card-img-top" alt="{{ actividad.titulo }}">
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">{{ actividad.titulo }}</h5>
                    <p class="card-text">{{ actividad.descripcion|truncatewords:30 }}</p>
                    <p><strong>Fecha:</strong> {{ actividad.fecha }}</p>
                    <p><strong>Hora:</strong> {{ actividad.hora_inicio }} - {{ actividad.hora_fin }}</p>
                    <p><strong>Lugar:</strong> {{ actividad.lugar }}</p>
                    <p><strong>Precio:</strong> ${{ actividad.precio }}</p>
                    <p><strong>Cupos disponibles:</strong> {{ actividad.espacios_disponibles }}</p>
                    
                    {% if not user.is_superuser and actividad.estado == 'activa' %}
                        {% if actividad.esta_llena %}
                            <button class="btn btn-secondary" disabled>Cupos Agotados</button>
                        {% else %}
                            {% with inscrito=actividad.inscripcionactividad_set.filter.exists %}
                                {% if inscrito %}
                                    <button class="btn btn-secondary" disabled>Ya estás inscrito</button>
                                {% else %}
                                    <button class="btn btn-success inscribir-btn" data-actividad-id="{{ actividad.id }}" data-precio="{{ actividad.precio }}">Inscribirse y Pagar</button>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    {% endif %}
                    
                    {% if user.is_superuser %}
                    <div class="mt-2">
                        <a href="{% url 'registrar_asistencia' actividad.id %}" class="btn btn-info">Registrar Asistencia</a>
                        {% if actividad.estado == 'activa' %}
                        <form method="post" action="{% url 'cancelar_actividad' actividad.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Cancelar Actividad</button>
                        </form>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <p>No hay actividades programadas en este momento.</p>
        </div>
        {% endfor %}
    </div>
</div>

{% if user.is_superuser %}
    <a href="{% url 'crear_actividad' %}" class="btn btn-primary mb-3">Crear Nueva Actividad</a>
    {% endif %}

{% if user.is_superuser %}
<!-- Scripts para los gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    var ctxTendencia = document.getElementById('tendenciaChart').getContext('2d');
    new Chart(ctxTendencia, {
        type: 'line',
        data: {
            labels: {{ meses|safe }},
            datasets: [{
                label: 'Actividades',
                data: {{ actividades_mensuales|safe }},
                borderColor: 'rgba(75, 192, 192, 1)',
                tension: 0.1,
                fill: false
            }, {
                label: 'Inscritos',
                data: {{ inscritos_mensuales|safe }},
                borderColor: 'rgba(255, 99, 132, 1)',
                tension: 0.1,
                fill: false
            }, {
                label: 'Ingresos ($)',
                data: {{ ingresos_mensuales|safe }},
                borderColor: 'rgba(54, 162, 235, 1)',
                tension: 0.1,
                fill: false,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
</script>
{% endif %}

<script>
    document.querySelectorAll('.inscribir-btn').forEach(button => {
        button.addEventListener('click', function() {
            const actividadId = this.getAttribute('data-actividad-id');
            const precio = this.getAttribute('data-precio');
            
            // Alerta de confirmación de SweetAlert2
            Swal.fire({
                title: '¿Estás seguro?',
                text: `El precio de la inscripción es $${precio}. ¿Quieres continuar?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, inscribirme',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Si el usuario confirma, ejecutar el fetch para el pago
                    fetch(`/actividades/${actividadId}/inscribir/`, {
                        method: 'POST',
                        body: JSON.stringify({ actividad_id: actividadId }),
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = `${data.payment_url}?token_ws=${data.token}`;
                        } else {
                            Swal.fire('Error', data.error, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'Hubo un problema al procesar la inscripción.', 'error');
                    });
                }
            });
        });
    });
</script>
{% endblock %}
