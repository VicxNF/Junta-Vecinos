{% extends 'junta_vecinos/base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>Actividades Vecinales</h2>
    
    {% if user.is_superuser %}
    <a href="{% url 'crear_actividad' %}" class="btn btn-primary mb-3">Crear Nueva Actividad</a>
    {% endif %}
    
    <div class="row">
        {% for actividad in actividades %}
        <div class="col-md-4 mb-4">
            <div class="card">
                {% if actividad.imagen %}
                <img src="{{ actividad.imagen.url }}" class="card-img-top" alt="{{ actividad.titulo }}">
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">{{ actividad.titulo }}</h5>
                    <p class="card-text">{{ actividad.descripcion|truncatewords:30 }}</p>
                    <p><strong>Fecha:</strong> {{ actividad.fecha }}</p>
                    <p><strong>Hora:</strong> {{ actividad.hora_inicio }} - {{ actividad.hora_fin }}</p>
                    <p><strong>Lugar:</strong> {{ actividad.lugar }}</p>
                    <p><strong>Cupos disponibles:</strong> {{ actividad.espacios_disponibles }}</p>
                    
                    {% if not user.is_superuser and actividad.estado == 'activa' %}
                        {% if actividad.esta_llena %}
                            <button class="btn btn-secondary" disabled>Cupos Agotados</button>
                        {% else %}
                            {% with inscrito=actividad.inscripcionactividad_set.filter.exists %}
                                {% if inscrito %}
                                    <button class="btn btn-secondary" disabled>Ya est√°s inscrito</button>
                                {% else %}
                                    <form method="post" action="{% url 'inscribir_actividad' actividad.id %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success">Inscribirse</button>
                                    </form>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    {% endif %}
                    
                    {% if user.is_superuser %}
                    <div class="mt-2">
                        <a href="{% url 'registrar_asistencia' actividad.id %}" class="btn btn-info">Registrar Asistencia</a>
                        {% if actividad.estado == 'activa' %}
                        <form method="post" action="{% url 'cancelar_actividad' actividad.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Cancelar Actividad</button>
                        </form>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <p>No hay actividades programadas en este momento.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
