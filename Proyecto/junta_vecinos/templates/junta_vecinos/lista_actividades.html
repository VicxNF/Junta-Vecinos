{% extends 'junta_vecinos/base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>Actividades Vecinales</h2>
    
    {% if user.is_superuser %}
    <a href="{% url 'crear_actividad' %}" class="btn btn-primary mb-3">Crear Nueva Actividad</a>
    {% endif %}
    
    <div class="row">
        {% for actividad in actividades %}
        <div class="col-md-4 mb-4">
            <div class="card">
                {% if actividad.imagen %}
                <img src="{{ actividad.imagen.url }}" class="card-img-top" alt="{{ actividad.titulo }}">
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">{{ actividad.titulo }}</h5>
                    <p class="card-text">{{ actividad.descripcion|truncatewords:30 }}</p>
                    <p><strong>Fecha:</strong> {{ actividad.fecha }}</p>
                    <p><strong>Hora:</strong> {{ actividad.hora_inicio }} - {{ actividad.hora_fin }}</p>
                    <p><strong>Lugar:</strong> {{ actividad.lugar }}</p>
                    <p><strong>Precio:</strong> ${{ actividad.precio }}</p>
                    <p><strong>Cupos disponibles:</strong> {{ actividad.espacios_disponibles }}</p>
                    
                    {% if not user.is_superuser and actividad.estado == 'activa' %}
                        {% if actividad.esta_llena %}
                            <button class="btn btn-secondary" disabled>Cupos Agotados</button>
                        {% else %}
                            {% with inscrito=actividad.inscripcionactividad_set.filter.exists %}
                                {% if inscrito %}
                                    <button class="btn btn-secondary" disabled>Ya estás inscrito</button>
                                {% else %}
                                    <button class="btn btn-success inscribir-btn" data-actividad-id="{{ actividad.id }}" data-precio="{{ actividad.precio }}">Inscribirse y Pagar</button>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    {% endif %}
                    
                    {% if user.is_superuser %}
                    <div class="mt-2">
                        <a href="{% url 'registrar_asistencia' actividad.id %}" class="btn btn-info">Registrar Asistencia</a>
                        {% if actividad.estado == 'activa' %}
                        <form method="post" action="{% url 'cancelar_actividad' actividad.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Cancelar Actividad</button>
                        </form>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <p>No hay actividades programadas en este momento.</p>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    document.querySelectorAll('.inscribir-btn').forEach(button => {
        button.addEventListener('click', function() {
            const actividadId = this.getAttribute('data-actividad-id');
            const precio = this.getAttribute('data-precio');
            
            // Alerta de confirmación de SweetAlert2
            Swal.fire({
                title: '¿Estás seguro?',
                text: `El precio de la inscripción es $${precio}. ¿Quieres continuar?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, inscribirme',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Si el usuario confirma, ejecutar el fetch para el pago
                    fetch(`/actividades/${actividadId}/inscribir/`, {
                        method: 'POST',
                        body: JSON.stringify({ actividad_id: actividadId }),
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = `${data.payment_url}?token_ws=${data.token}`;
                        } else {
                            Swal.fire('Error', data.error, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'Hubo un problema al procesar la inscripción.', 'error');
                    });
                }
            });
        });
    });
</script>
{% endblock %}
