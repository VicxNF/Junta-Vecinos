{% extends 'junta_vecinos/base.html' %}

{% block title %}Lista de Reservas{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Título con la comuna -->
    <h1 class="mb-4">Reservas de {{ comuna }}</h1>
    
    <!-- Sección de Estadísticas Rápidas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title mb-4">Estadísticas Generales</h3>
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <h5>Total Reservas</h5>
                            <h2 class="text-primary">{{ reservas|length }}</h2>
                        </div>
                        <div class="col-md-4 text-center">
                            <h5>Espacios Activos</h5>
                            <h2 class="text-success">{{ espacios|length }}</h2>
                        </div>
                        <div class="col-md-4 text-center">
                            <h5>Ingresos Totales</h5>
                            <h2 class="text-info">${{ total_ingresos|floatformat:2 }}</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Lista de Reservas -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title mb-4">Lista de Reservas</h2>
                    <div class="list-group">
                        {% for reserva in reservas %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">{{ reserva.espacio.nombre }}</h5>
                                <small>${{ reserva.monto_pagado|floatformat:2 }}</small>
                            </div>
                            <p class="mb-1">{{ reserva.fecha|date:"d/m/Y" }} de {{ reserva.hora_inicio|time:"H:i" }} a {{ reserva.hora_fin|time:"H:i" }}</p>
                            <small>Reservado por: {{ reserva.usuario.get_full_name }}</small>
                        </div>
                        {% empty %}
                        <div class="text-center py-3">
                            <p>No hay reservas registradas</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="card-title mb-4">Distribución de Reservas</h2>
                    <canvas id="reservasChart"></canvas>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="card-title mb-4">Tendencia Mensual</h2>
                    <canvas id="tendenciaChart"></canvas>
                </div>
            </div>

            <!-- Formulario de Generación de Reportes -->
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title mb-4">Generar Reporte</h2>
                    <form method="get" action="{% url 'generar_reporte_pdf' %}" class="row g-3">
                        <div class="col-md-6">
                            <label for="year" class="form-label">Año</label>
                            <select name="year" id="year" class="form-select">
                                {% for year in years %}
                                    <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>
                                        {{ year }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="month" class="form-label">Mes</label>
                            <select name="month" id="month" class="form-select">
                                {% for month_num, month_name in months %}
                                    <option value="{{ month_num }}" {% if month_num == current_month %}selected{% endif %}>
                                        {{ month_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-file-pdf me-2"></i>Generar Reporte PDF
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Configuración del gráfico de torta
    var ctx = document.getElementById('reservasChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: {{ espacios|safe }},
            datasets: [{
                data: {{ totales|safe }},
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 159, 64, 0.8)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Reservas por Espacio'
                }
            }
        }
    });

    // Configuración del gráfico de tendencia
    var ctxTendencia = document.getElementById('tendenciaChart').getContext('2d');
    new Chart(ctxTendencia, {
        type: 'line',
        data: {
            labels: {{ meses|safe }},
            datasets: [{
                label: 'Reservas',
                data: {{ reservas_mensuales|safe }},
                borderColor: 'rgba(75, 192, 192, 1)',
                tension: 0.1,
                fill: false
            }, {
                label: 'Ingresos ($)',
                data: {{ ingresos_mensuales|safe }},
                borderColor: 'rgba(255, 99, 132, 1)',
                tension: 0.1,
                fill: false,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Número de Reservas'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Ingresos ($)'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Tendencia Mensual'
                }
            }
        }
    });
</script>
{% endblock %}